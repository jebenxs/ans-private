<!DOCTYPE html>
<html>
<head>
  <title>Laporan Aktivitas Karyawan (Responsive)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <style>
    /* ---------------------------------------------------- */
    /* 1. STYLING DASAR & RESPONSIVITAS MOBILE-FIRST */
    /* ---------------------------------------------------- */
    :root { font-size: 16px; }
    body { 
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        padding: 0; 
        margin: 0;
        background-color: #f3f4f6; 
        color: #1f2937; 
        min-width: 320px;
    }
    .container {
        padding: 1rem; 
        max-width: 100%;
        box-sizing: border-box; 
    }
    h2, h3 { 
        color: #111827; 
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
    }
    .status-msg { text-align: center; margin-top: 0.5rem; font-weight: 600; font-size: 0.875rem;}

    /* ---------------------------------------------------- */
    /* 2. LOADING SPINNER (MODAL) */
    /* ---------------------------------------------------- */
    #loadingModal {
        display: none; /* Default hidden */
        position: fixed; 
        z-index: 9999; 
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; 
        background-color: rgba(0,0,0,0.5); /* Semi-transparent background */
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
    }

    .spinner {
        border: 4px solid #f3f3f3; 
        border-top: 4px solid #2563eb; 
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-top: -20px;
        margin-left: -20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ---------------------------------------------------- */
    /* 3. FORM INPUT & BUTTONS */
    /* ---------------------------------------------------- */
    .form-container { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); margin-bottom: 1.25rem;}
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem;}
    @media (min-width: 600px) { .form-group { flex-direction: row; align-items: center; } }
    .form-group label { font-size: 0.875rem; font-weight: 500; color: #374151; flex-shrink: 0;}
    .form-group select { padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background-color: #ffffff; font-size: 1rem; flex-grow: 1;}
    .form-group button { 
        padding: 0.6rem 1rem; background-color: #2563eb; color: white; border: none; border-radius: 0.375rem; cursor: pointer; 
        font-weight: 600; transition: background-color 0.2s; width: 100%; -webkit-appearance: none; appearance: none;
    }
    .form-group button:hover { background-color: #1d4ed8; } 
    
    /* ---------------------------------------------------- */
    /* 4. SUMMARY */
    /* ---------------------------------------------------- */
    .summary-box { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 1.25rem; border: 1px solid #e5e7eb;}
    .summary-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;}
    .summary-item:last-child { border-bottom: none; }
    .label { font-weight: 500; color: #4b5563; } 
    .value { font-weight: 700; color: #2563eb; text-align: right; } 

    /* ---------------------------------------------------- */
    /* 5. TABEL (Horizontal Scroll) */
    /* ---------------------------------------------------- */
    .table-responsive { 
        overflow-x: auto; 
        margin-top: 1rem; 
        border-radius: 0.5rem; 
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
        background-color: white;
    }
    table { 
        width: 100%; 
        min-width: 750px; 
        border-collapse: collapse; 
        background-color: white; 
    }
    th, td { 
        border: 1px solid #e5e7eb; 
        padding: 0.75rem 0.5rem; 
        text-align: center; 
        font-size: 0.85rem; 
        white-space: nowrap; 
    }
    th { 
        background-color: #eff6ff; 
        color: #1e40af; 
        position: sticky; 
        top: 0; 
        font-weight: 700; 
        z-index: 10; 
    }
    #dailyTable tbody tr:nth-child(even) { background-color: #f9fafb; } 

    /* ---------------------------------------------------- */
    /* 6. FORMAT BERSYARAT (Conditional Formatting) */
    /* ---------------------------------------------------- */
    .bg-red { background-color: #fee2e2 !important; color: #b91c1c; } 
    .bg-green { background-color: #d1fae5 !important; color: #b91c1c; font-weight: bold;} 
    .bg-amber { background-color: #fffbeb !important; color: #b45309; } 
    .strikethrough { text-decoration: line-through; } 
  </style>
</head>
<body>
  
  <div id="loadingModal">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <h2>An's Work Bismillah</h2>
    
    <h3>Pilih Bulan dan Tahun</h3>
    <div class="form-container">
      <form id="periodForm">
        <div class="form-group">
          <label for="bulan">Bulan:</label>
          <select id="bulan" name="bulan" required>
            <option value="JANUARI">JANUARI</option><option value="FEBRUARI">FEBRUARI</option><option value="MARET">MARET</option>
            <option value="APRIL">APRIL</option><option value="MEI">MEI</option><option value="JUNI">JUNI</option>
            <option value="JULI">JULI</option><option value="AGUSTUS">AGUSTUS</option><option value="SEPTEMBER">SEPTEMBER</option>
            <option value="OKTOBER">OKTOBER</option><option value="NOVEMBER">NOVEMBER</option><option value="DESEMBER">DESEMBER</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tahun">Tahun:</label>
          <select id="tahun" name="tahun" required></select>
        </div>
        <div class="form-group">
          <button type="submit">Filter & Muat Ulang</button>
        </div>
      </form>
    </div>
    
    
	<h3 id="reportTitle">Estimasi Slip Gaji </h3>
    <div id="statusMessage" class="status-msg" style="color:red;"></div>
    <div id="summaryDisplay" class="summary-box"></div>

    <h3 id="tableTittle">Rekap Data</h3>
    <div class="table-responsive">
        <table id="dailyTable">
            <thead>
                <tr>
                    <th>TANGGAL</th><th>HARI</th><th>STATUS HARI</th><th>CEKLOK</th><th>LEMBUR</th><th>SAP MENTAH</th>
                    <th>SAP MASAK</th><th>GANT. MENTAH</th><th>GANT. MASAK</th><th>KETERANGAN</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
  </div> 
  
  <script>
    // GANTI URL INI DENGAN URL DEPLOYMENT EXEC UTAMA DARI Apps Script doGet Anda
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbz5RBFqX-5qRNNX7o4furDr9gIFHGYEIZoThxLUNWSROf2nITPH_F8WElXQ_1nNGdg3Ww/exec'; 
    const loadingModal = document.getElementById('loadingModal');

    // --- UTILITY FUNCTIONS ---
    
    // Fungsi untuk memformat angka tanpa koma di belakang (desimal)
    function formatNumber(value) {
        if (typeof value === 'number') {
            // Gunakan minimumFractionDigits: 0 dan maximumFractionDigits: 0 untuk menghilangkan desimal
            return value.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); 
        }
        return value;
    }

    function createSummaryItem(label, value) {
        if (!label || !value) return null;
        const row = document.createElement('div');
        row.className = 'summary-item';
        
        // Panggil fungsi formatNumber untuk ringkasan
        const displayValue = formatNumber(value);

        row.innerHTML = `<span class="label">${label}</span><span class="value">${displayValue}</span>`;
        return row;
    }
    
    // --- RENDER DATA ---
    function renderData(data) {
        const dataLaporan = data.data; 
        
        // Bersihkan
        document.getElementById('summaryDisplay').innerHTML = '';
        document.getElementById('dailyTable').getElementsByTagName('tbody')[0].innerHTML = '';

        // 1. Update Form, Header
        document.getElementById('bulan').value = dataLaporan.bulan;
        document.getElementById('tahun').value = dataLaporan.tahun;
        document.getElementById('reportTitle').textContent = `Estimasi Gaji Bulan ${dataLaporan.bulan} ${dataLaporan.tahun}`;
		document.getElementById('tableTittle').textContent = `Rekap Data ${dataLaporan.bulan} ${dataLaporan.tahun}`;
        
        // 2. Render Summary
        const summaryDiv = document.getElementById('summaryDisplay');
        const sData = dataLaporan.summary;
        // Referensi Sel A1:L4 (sama seperti sebelumnya)
        const summaryItems = [
            { label: sData[0][0], value: sData[0][1] }, { label: sData[1][0], value: sData[1][1] },
            { label: sData[2][0], value: sData[2][1] }, { label: sData[3][0], value: sData[3][1] },
            { label: "Estimasi Gaji", value: sData[1][5] }, // Estimasi Gaji
            { label: sData[0][10], value: sData[0][11] }, // Jam Lembur
            { label: sData[1][10], value: sData[1][11] } // Lembur Masak
        ];
        summaryItems.forEach(item => {
            const element = createSummaryItem(item.label, item.value);
            if(element) summaryDiv.appendChild(element);
        });

        // 3. Render Daily Table + FORMAT BERSYARAT
        const tbody = document.getElementById('dailyTable').getElementsByTagName('tbody')[0];
        dataLaporan.daily.forEach(row => {
            if (row.every(cell => cell === "" || cell === null)) return; 
            
            const tr = tbody.insertRow();
            
            // --- LOGIC FORMAT BERSYARAT ---
            const statusHari = String(row[2] || '').toUpperCase().trim(); // Kolom Status Hari (Index 2)
            const ciclok = parseFloat(row[3]) || 0; // Kolom CICLOK (Index 3)
            let rowClass = '';
            let applyStrikethrough = false;
            
            if (statusHari.includes('LIBUR') || statusHari.includes('MINGGU')) {
                if (ciclok > 0) {
                    rowClass = 'bg-green'; 
                } else {
                    rowClass = 'bg-red'; 
                    applyStrikethrough = true; 
                }
            } else if (statusHari.includes('HK') && ciclok === 0) {
                rowClass = 'bg-amber'; 
                applyStrikethrough = true;
            }
            if (rowClass) { tr.classList.add(rowClass); }

            // Render Cell
            row.forEach((cellData) => {
                const td = tr.insertCell();
                
                if (cellData instanceof Date) {
                    td.textContent = new Date(cellData).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                } else if (typeof cellData === 'number') {
                    // Hanya untuk daily table kita izinkan desimal (jika ada)
                    td.textContent = cellData.toLocaleString('id-ID'); 
                } else {
                    td.textContent = cellData;
                }
                
                if (applyStrikethrough) { 
                    td.classList.add('strikethrough'); 
                }
            });
        });
        
        // Tampilkan pesan status berhasil
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = data.message;
        statusDiv.style.color = 'green';
    }

    // --- FETCH DATA FUNCTION ---
    async function fetchData(bulan, tahun) {
        const statusDiv = document.getElementById('statusMessage');
        
        // Tampilkan Spinner Modal
        loadingModal.style.display = 'block';

        try {
            const url = `${API_ENDPOINT}?bulan=${bulan.toUpperCase()}&tahun=${tahun}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            // Sembunyikan Spinner Modal
            loadingModal.style.display = 'none';

            if (result.success) {
                renderData(result);
            } else {
                statusDiv.textContent = result.message;
                statusDiv.style.color = 'red';
            }
        } catch (error) {
            // Sembunyikan Spinner Modal
            loadingModal.style.display = 'none';
            statusDiv.textContent = 'Error saat mengambil data: Pastikan URL API sudah benar dan di-deploy.';
            statusDiv.style.color = 'red';
            console.error('Fetch Error:', error);
        }
    }

    // --- INITIALIZATION ---

    function initializeYearDropdown() {
        const selectTahun = document.getElementById('tahun');
        const currentYear = new Date().getFullYear();
        const startYear = 2025;
        const defaultYear = currentYear + 1; // Default: Tahun Sekarang + 1

        for (let year = startYear; year <= defaultYear; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            selectTahun.appendChild(option);
        }
        
        // Set default value
        selectTahun.value = defaultYear;
    }

    window.onload = function() {
        initializeYearDropdown();
        
        // Muat data awal dengan nilai default form
        const defaultBulan = document.getElementById('bulan').value;
        const defaultTahun = document.getElementById('tahun').value;
        fetchData(defaultBulan, defaultTahun); 
    };
    
    // --- LOGIKA SUBMIT FORM FILTER ---
    document.getElementById('periodForm').addEventListener('submit', function(e) {
      e.preventDefault(); 
      const form = e.target;
      fetchData(form.bulan.value, form.tahun.value);
    });
  </script>
</body>
</html>
