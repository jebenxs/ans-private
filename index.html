<!DOCTYPE html>
<html>
<head>
  <title>Laporan Aktivitas Karyawan (Responsive)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <style>
    /* CSS RESPONSIF PENUH (Memastikan tidak ada masalah 980px lagi) */
    :root { font-size: 16px; }
    body { 
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        padding: 0; 
        margin: 0;
        background-color: #f3f4f6; 
        color: #1f2937; 
        min-width: 320px;
    }
    .container {
        padding: 1rem; 
        max-width: 100%;
        box-sizing: border-box; 
    }
    h2, h3 { 
        color: #111827; 
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
    }
    /* FORM INPUT & BUTTONS */
    .form-container { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); margin-bottom: 1.25rem;}
    .form-group { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.75rem;}
    @media (min-width: 600px) { .form-group { flex-direction: row; align-items: center; } }
    .form-group label { font-size: 0.875rem; font-weight: 500; color: #374151; flex-shrink: 0;}
    .form-group select { padding: 0.5rem 0.75rem; border-radius: 0.375rem; border: 1px solid #d1d5db; background-color: #ffffff; font-size: 1rem; flex-grow: 1;}
    .form-group button { 
        padding: 0.6rem 1rem; background-color: #2563eb; color: white; border: none; border-radius: 0.375rem; cursor: pointer; 
        font-weight: 600; transition: background-color 0.2s; width: 100%; -webkit-appearance: none; appearance: none;
    }
    .form-group button:hover { background-color: #1d4ed8; } 
    
    /* SUMMARY */
    .summary-box { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 1.25rem; border: 1px solid #e5e7eb;}
    .summary-item { display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;}
    .summary-item:last-child { border-bottom: none; }
    .label { font-weight: 500; color: #4b5563; } 
    .value { font-weight: 700; color: #2563eb; text-align: right; } 

    /* TABEL (Horizontal Scroll) */
    .table-responsive { overflow-x: auto; margin-top: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); background-color: white;}
    table { width: auto; min-width: 750px; border-collapse: collapse; background-color: white; }
    th, td { border: 1px solid #e5e7eb; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.85rem; white-space: nowrap; }
    th { background-color: #eff6ff; color: #1e40af; position: sticky; top: 0; font-weight: 700; z-index: 10; }
    #dailyTable tbody tr:nth-child(even) { background-color: #f9fafb; } 

    /* FORMAT BERSYARAT */
    .bg-red { background-color: #fee2e2 !important; color: #b91c1c; } 
    .bg-green { background-color: #d1fae5 !important; color: #065f46; font-weight: bold;} 
    .bg-amber { background-color: #fffbeb !important; color: #b45309; } 
    .strikethrough { text-decoration: line-through; } 
    .status-msg { text-align: center; margin-top: 0.5rem; font-weight: 600; font-size: 0.875rem;}
  </style>
</head>
<body>
  <div class="container">
    <h2 id="reportTitle">Laporan Aktivitas</h2>
    <div id="statusMessage" class="status-msg" style="color:red;"></div>
    <div id="loading" class="status-msg">Memuat data, harap tunggu...</div>

    <h3>Ubah Periode Laporan</h3>
    <div class="form-container">
      <form id="periodForm">
        <div class="form-group">
          <label for="bulan">Bulan:</label>
          <select id="bulan" name="bulan" required>
            <option value="JANUARI">JANUARI</option><option value="FEBRUARI">FEBRUARI</option><option value="MARET">MARET</option>
            <option value="APRIL">APRIL</option><option value="MEI">MEI</option><option value="JUNI">JUNI</option>
            <option value="JULI">JULI</option><option value="AGUSTUS">AGUSTUS</option><option value="SEPTEMBER">SEPTEMBER</option>
            <option value="OKTOBER">OKTOBER</option><option value="NOVEMBER">NOVEMBER</option><option value="DESEMBER">DESEMBER</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tahun">Tahun:</label>
          <select id="tahun" name="tahun" required>
            <option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option>
          </select>
        </div>
        <div class="form-group">
          <button type="submit">Filter & Muat Ulang</button>
        </div>
      </form>
    </div>
    
    <h3>Ringkasan Keuangan</h3>
    <div id="summaryDisplay" class="summary-box"></div>

    <h3>Data Harian</h3>
    <div class="table-responsive">
        <table id="dailyTable">
            <thead>
                <tr>
                    <th>TANGGAL</th><th>HARI</th><th>STATUS HARI</th><th>CICLOK</th><th>LEMBUR</th><th>MENTAH</th>
                    <th>MASAK</th><th>GANT. MENTAH</th><th>GANT. MASAK</th><th>KET</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
  </div> 
  
  <script>
    // GANTI URL INI DENGAN URL DEPLOYMENT EXEC UTAMA DARI Apps Script doGet Anda
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbz5RBFqX-5qRNNX7o4furDr9gIFHGYEIZoThxLUNWSROf2nITPH_F8WElXQ_1nNGdg3Ww/exec';
    // --- UTILITY FUNCTIONS ---
    function createSummaryItem(label, value) {
        if (!label || !value) return null;
        const row = document.createElement('div');
        row.className = 'summary-item';
        const displayValue = typeof value === 'number' ? value.toLocaleString('id-ID') : value;
        row.innerHTML = `<span class="label">${label}</span><span class="value">${displayValue}</span>`;
        return row;
    }
    
    function renderData(data) {
        const dataLaporan = data.data; // Akses properti 'data' dari respons API
        document.getElementById('loading').style.display = 'none';
        
        document.getElementById('summaryDisplay').innerHTML = '';
        document.getElementById('dailyTable').getElementsByTagName('tbody')[0].innerHTML = '';

        document.getElementById('bulan').value = dataLaporan.bulan;
        document.getElementById('tahun').value = dataLaporan.tahun;
        document.getElementById('reportTitle').textContent = `Laporan Bulan ${dataLaporan.bulan} ${dataLaporan.tahun}`;

        // 1. Render Summary
        const summaryDiv = document.getElementById('summaryDisplay');
        const sData = dataLaporan.summary;
        const summaryItems = [
            { label: sData[0][0], value: sData[0][1] }, { label: sData[1][0], value: sData[1][1] }, 
            { label: sData[2][0], value: sData[2][1] }, { label: sData[3][0], value: sData[3][1] }, 
            { label: sData[1][4], value: sData[1][5] }, { label: sData[0][10], value: sData[0][11] }, 
            { label: sData[1][10], value: sData[1][11] } 
        ];
        summaryItems.forEach(item => {
            const element = createSummaryItem(item.label, item.value);
            if(element) summaryDiv.appendChild(element);
        });

        // 2. Render Daily Table
        const tbody = document.getElementById('dailyTable').getElementsByTagName('tbody')[0];
        dataLaporan.daily.forEach(row => {
            if (row.every(cell => cell === "" || cell === null)) return; 
            const tr = tbody.insertRow();
            const statusHari = String(row[2]).toUpperCase().trim(); 
            const ciclok = parseFloat(row[3]) || 0; 
            let rowClass = '';
            let applyStrikethrough = false;

            if (statusHari.includes('LIBUR NASIONAL') || statusHari.includes('MINGGU')) {
                if (ciclok > 0) {
                    rowClass = 'bg-green';
                } else {
                    rowClass = 'bg-red'; 
                    applyStrikethrough = true;
                }
            } else if (statusHari.includes('HK') && ciclok === 0) {
                rowClass = 'bg-amber';
                applyStrikethrough = true;
            }
            if (rowClass) { tr.classList.add(rowClass); }

            row.forEach((cellData) => {
                const td = tr.insertCell();
                if (cellData instanceof Date) {
                    td.textContent = new Date(cellData).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                } else if (typeof cellData === 'number') {
                    td.textContent = cellData.toLocaleString('id-ID'); 
                } else {
                    td.textContent = cellData;
                }
                if (applyStrikethrough) { td.classList.add('strikethrough'); }
            });
        });
        
        // Tampilkan pesan status berhasil
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = data.message;
        statusDiv.style.color = 'green';
    }

    // --- FETCH DATA FUNCTION ---
    async function fetchData(bulan, tahun) {
        document.getElementById('statusMessage').textContent = '';
        document.getElementById('loading').textContent = 'Memuat data, harap tunggu...';
        document.getElementById('loading').style.display = 'block';

        try {
            const url = `${API_ENDPOINT}?bulan=${bulan.toUpperCase()}&tahun=${tahun}`;
            
            const response = await fetch(url);
            const result = await response.json();

            document.getElementById('loading').style.display = 'none';

            if (result.success) {
                renderData(result);
            } else {
                document.getElementById('statusMessage').textContent = result.message;
                document.getElementById('statusMessage').style.color = 'red';
            }
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('statusMessage').textContent = 'Error saat mengambil data: Pastikan URL API sudah benar dan di-deploy sebagai "Executor" (Anyone).';
            document.getElementById('statusMessage').style.color = 'red';
            console.error('Fetch Error:', error);
        }
    }

    // --- INITIAL LOAD AND FORM SUBMISSION ---
    window.onload = function() {
        // Ambil nilai default dari form untuk load awal
        const defaultBulan = document.getElementById('bulan').value;
        const defaultTahun = document.getElementById('tahun').value;
        fetchData(defaultBulan, defaultTahun); 
    };
    
    document.getElementById('periodForm').addEventListener('submit', function(e) {
      e.preventDefault(); 
      const form = e.target;
      fetchData(form.bulan.value, form.tahun.value);
    });
  </script>
</body>
</html>
